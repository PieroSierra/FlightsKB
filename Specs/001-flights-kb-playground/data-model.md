# Data Model: Flights KB Playground

**Branch**: `001-flights-kb-playground`
**Created**: 2026-02-01

## Entity Overview

```
┌─────────────┐       1:N       ┌─────────────┐
│  Document   │────────────────▶│    Chunk    │
└─────────────┘                 └─────────────┘
       │                               │
       │ has                           │ stored in
       ▼                               ▼
┌─────────────┐                 ┌─────────────┐
│   Source    │                 │ VectorIndex │
└─────────────┘                 └─────────────┘
                                       │
                                       │ validated by
                                       ▼
                                ┌─────────────┐
                                │  TestQuery  │
                                └─────────────┘
```

---

## Entities

### 1. Document

A Markdown file representing a unit of flight knowledge with YAML frontmatter metadata.

**Storage**: File system (`knowledge/{category}/{filename}.md`)

#### Required Fields

| Field | Type | Description | Validation |
|-------|------|-------------|------------|
| `kb_id` | string | Globally unique stable identifier | Required, unique across all documents |
| `type` | string | Document type classification | Required, e.g., "airline_premium_fare", "hack", "lounge_tip" |
| `title` | string | Human-readable document title | Required, non-empty |
| `created` | date | Document creation date | Required, format: YYYY-MM-DD |
| `updated` | date | Last modification date | Required, format: YYYY-MM-DD |
| `status` | enum | Document lifecycle status | Required, one of: "draft", "reviewed", "deprecated" |
| `source` | Source | Provenance information | Required, embedded object |
| `confidence` | enum | Content reliability level | Required, one of: "low", "medium", "high" |

#### Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `tags` | string[] | Freeform classification tags |
| `entities` | Entities | Structured entity references (see below) |
| `temporal` | Temporal | Time-bound validity (see below) |
| `geo` | Geo | Geographic applicability |
| `audience` | enum | Target audience: "pm", "traveler", "ops", "mixed" |
| `license` | License | Reuse permissions |

#### Nested Types

**Entities** (optional):
| Field | Type | Example |
|-------|------|---------|
| `airline` | string | "BA" |
| `alliance` | string | "oneworld" |
| `airports` | string[] | ["LHR", "JFK"] |
| `routes` | string[] | ["LHR-JFK"] |
| `cabins` | string[] | ["premium_economy", "business"] |
| `aircraft` | string[] | ["A350-1000"] |
| `flight_numbers` | string[] | ["BA117"] |

**Temporal** (optional):
| Field | Type | Description |
|-------|------|-------------|
| `effective_from` | date? | Start of validity period |
| `effective_to` | date? | End of validity period |

**Geo** (optional):
| Field | Type | Example |
|-------|------|---------|
| `regions` | string[] | ["EU", "US"] |

**License** (optional):
| Field | Type | Description |
|-------|------|-------------|
| `reuse` | enum | "ok", "restricted", "unknown" |
| `notes` | string? | Additional licensing context |

---

### 2. Source

Provenance information tracking where knowledge originated. Embedded in Document.

| Field | Type | Description | Validation |
|-------|------|-------------|------------|
| `kind` | enum | Source category | Required, one of: "internal", "ugc", "marketing", "press", "blog", "forum", "other" |
| `name` | string | Source name/author | Required, non-empty |
| `url` | string? | Source URL if web-based | Optional, valid URL if present |
| `retrieved` | date? | Date content was retrieved | Required if `url` is present |

---

### 3. Chunk (Card)

A searchable section within a document, representing a single piece of knowledge.

**Storage**: Vector database (ChromaDB collection)

#### Fields

| Field | Type | Description | Derivation |
|-------|------|-------------|------------|
| `chunk_id` | string | Unique chunk identifier | `${kb_id}#${slug(heading)}` |
| `doc_id` | string | Parent document kb_id | Copied from document |
| `title` | string | Section heading | Extracted from `## heading` |
| `text` | string | Full card markdown content | Everything under `## heading` until next heading |
| `metadata` | object | Merged doc + card selectors | Combined frontmatter + applies-to DSL |
| `source` | Source | Document source + evidence | From doc, plus evidence line if present |
| `hash` | string | Content hash | SHA-256 of normalized text |
| `embedding` | float[] | Vector representation | Generated by embedding model |

#### Card-Level Fields (parsed from markdown)

| Field | Type | Description |
|-------|------|-------------|
| `claim_type` | enum? | "fact", "evaluation", "tactic", "rule_of_thumb", "warning", "comparison" |
| `applies_to` | object? | Parsed selector DSL (airline, route, cabin, etc.) |
| `summary` | string? | Brief summary if present |
| `structured_blob` | object? | Parsed JSON block if present in card |

#### Applies-To DSL Keys

When parsing `**Applies to:**` content, normalize these keys:
- `airline` → single airline code
- `airports` → list of airport codes
- `routes` → list of route pairs (e.g., "LHR-JFK")
- `cabin` → cabin class
- `aircraft` → aircraft type
- `flight` → specific flight number
- `alliance` → airline alliance
- `region` → geographic region

---

### 4. VectorIndex

The derived index containing embeddings for all chunks. Rebuildable from source.

**Storage**: ChromaDB persistent directory

#### Index Metadata

| Field | Type | Description |
|-------|------|-------------|
| `collection_name` | string | ChromaDB collection identifier |
| `embedding_model` | string | Model used for embeddings |
| `embedding_dimensions` | int | Vector dimensionality |
| `last_rebuild` | datetime | Timestamp of last full rebuild |
| `document_count` | int | Number of source documents |
| `chunk_count` | int | Number of indexed chunks |

#### Query Interface

**Input**:
| Field | Type | Description |
|-------|------|-------------|
| `query_text` | string | Natural language query |
| `k` | int | Number of results to return |
| `filters` | object? | Metadata filters |

**Output** (per result):
| Field | Type | Description |
|-------|------|-------------|
| `chunk_id` | string | Unique chunk identifier |
| `kb_id` | string | Parent document ID |
| `title` | string | Chunk heading |
| `text` | string | Full chunk content |
| `metadata` | object | All chunk metadata |
| `score` | float | Similarity score (0-1, higher = more similar) |
| `file_path` | string | Source file location |

---

### 5. TestQuery

An evaluation record for measuring retrieval quality.

**Storage**: YAML file (`eval/test_queries.yaml`)

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Test case identifier |
| `query` | string | Natural language query text |
| `expected_kb_ids` | string[] | Document IDs that should be retrieved |
| `expected_topics` | string[]? | Alternative: topic keywords to match |
| `k` | int | Number of results to check (default: 3) |

#### Evaluation Output

| Field | Type | Description |
|-------|------|-------------|
| `query_id` | string | Test case ID |
| `recall_at_k` | float | Proportion of expected results found |
| `found` | string[] | Expected IDs that were retrieved |
| `missed` | string[] | Expected IDs not in top-k |
| `actual_results` | string[] | All retrieved chunk IDs |

---

## State Transitions

### Document Status Lifecycle

```
draft ──────▶ reviewed ──────▶ deprecated
  │              │
  │              │
  └──────────────┴──── (can revert to draft for edits)
```

- **draft**: Initial state, content being developed
- **reviewed**: Content verified, ready for use
- **deprecated**: Outdated, kept for reference but flagged

---

## Validation Rules

### Document Validation

1. `kb_id` must be unique across all documents
2. `kb_id` must be stable - never change after creation
3. `created` must not be in the future
4. `updated` must be >= `created`
5. If `source.url` is present, `source.retrieved` is required
6. `temporal.effective_to` must be >= `temporal.effective_from` if both present

### Chunk Validation

1. `chunk_id` must follow format `${kb_id}#${slug}`
2. `text` must be non-empty
3. `hash` must be deterministic - same content = same hash
4. Duplicate `chunk_id` within same rebuild indicates error

### Chunking Determinism

Running the chunker twice on identical source must produce:
- Identical `chunk_id` values
- Identical `text` content
- Identical `hash` values
- Same ordering of chunks

---

## File Path Conventions

### Knowledge Directory Structure
```
knowledge/
├── airlines/{iata_code}/       # e.g., airlines/BA/
├── airports/{iata_code}/       # e.g., airports/LHR/
├── loyalty/
├── hacks/
├── lounges/
├── reviews/
├── pricing-curves/
└── inbox/                      # Ingested content awaiting categorization
```

### Chunk ID Generation

```
slug(heading) = heading
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '')

chunk_id = `${kb_id}#${slug(heading)}`

# Example:
# kb_id: "ba-premium-economy-2024"
# heading: "Rule of thumb: LHR→JFK best booking window"
# chunk_id: "ba-premium-economy-2024#rule-of-thumb-lhr-jfk-best-booking-window"
```
